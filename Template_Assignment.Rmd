---
title: "Template"
author: "Studentnames and studentnumbers here"
date: "`r Sys.Date()`"
output: pdf_document
---

# Set-up your environment

```{r package_install, include=FALSE}
#install.packages("tidyverse")
```

```{r packages}
require(tidyverse)
library(readr)
```

# Title Page

Include your names

Include the tutorial group number

Include your tutorial lecturer's name

# Part 1 - Identify a Social Problem

Use APA referencing throughout your document. [Here's a link to some explanation.](https://www.mendeley.com/guides/apa-citation-guide/)

## 1.1 Describe the Social Problem

Include the following:

-   Why is this relevant?

-   ...

# Part 2 - Data Sourcing

## 2.1 Load in the data

Preferably from a URL, but if not, make sure to download the data and store it in a shared location that you can load the data in from. Do not store the data in a folder you include in the Github repository!

```{r loading_data}
Alcohol_data_2016<- read_csv("data/Data/Gezondheid_per_wijk_en_buurt__2022_18062025_140754.csv")

Alcohol_data_2020<- read_csv("data/Data/Gezondheid_per_wijk_en_buurt__2022_18062025_140356.csv")

Alcohol_data_2022<- read_csv("data/Data/Gezondheid_per_wijk_en_buurt__2022_18062025_140404.csv")

Nabijheid_voorzieningen2016 <- read_csv("data/Data/nabijheid_voorzieningen2016.csv")

Nabijheid_voorzieningen2020 <- read_csv("data/Data/nabijheid_voorzieningen2020.csv")

Nabijheid_voorzieningen2022 <- read_csv("data/Data/nabijheid_voorzieningen2022.csv")
```

midwest is an example dataset included in the tidyverse package

## 2.2 Provide a short summary of the dataset(s)

```{r}
#head(dataset)
```

In this case we see 28 variables, but we miss some information on what units they are in. We also don't know anything about the year/moment in which this data has been captured.

``` r
inline_code = TRUE
```

These are things that are usually included in the metadata of the dataset. For your project, you need to provide us with the information from your metadata that we need to understand your dataset of choice.

## 2.3 Describe the type of variables included

Think of things like:

-   Do the variables contain health information or SES information?

-   Have they been measured by interviewing individuals or is the data coming from administrative sources?

*For the sake of this example, I will continue with the assignment...*

# Part 3 - Quantifying

## 3.1 Data cleaning

Say we want to include only larger distances (above 2) in our dataset, we can filter for this.

```{r data_cleaning}
library(dplyr)
library(readr)
nabijheid_voorzieningen2016 <- read_csv("nabijheid_voorzieningen2016.csv")
nabijheid_voorzieningen2020 <- read_csv("nabijheid_voorzieningen2020.csv")
nabijheid_voorzieningen2022 <- read_csv("nabijheid_voorzieningen2022.csv")
```

Please use a separate 'R block' of code for each type of cleaning. So, e.g. one for missing values, a new one for removing unnecessary variables etc.

## 3.2 Generate necessary variables

Variable 1: Add a column, whether or not the distance to cafes is \>1

```{merged_data <- merged_data %>%}
  mutate(Distance_cafes = if_else(
    Horeca.Cafés.en.dergelijke.Afstand.tot.café.e.d...km.> 1,
    "Cafes further than 1 km",
    "Cafes closer than 1 km"
  ))

```

Variable 2 Kort beschrijven wat ongezondheidsscore inhoudt, gemiddelde van de onderstaande ongezondheidsfactoren.in het engels natuurlijk

```{r gen_var2}
library(dplyr)

# Kolommen selecteren voor de score
cols_to_convert <- c(
  "Roker....",
  "Alcoholgebruik.Zware.drinker....",
  "Alcoholgebruik.Overmatige.drinker....",
  "Lichamelijke.gezondheid.Eén.of.meer.langdurige.aandoeningen....",
  "Hoog.risico.op.angst.of.depressie....",
  "Eenzaamheid.Ernstig.zeer.ernstig.eenzaam...."
)

# Zet komma's naar punten en maak getallen van tekens
merged_data[cols_to_convert] <- lapply(merged_data[cols_to_convert], function(x) {
  x <- gsub(",", ".", x)
  as.numeric(x)
})

# Bereken de ongezondheid_score als gemiddelde van de gekozen kolommen
merged_data <- merged_data %>%
  mutate(
    ongezondheid_score = rowMeans(select(., all_of(cols_to_convert)), na.rm = TRUE)
  )


```

## 3.3 Visualize temporal variation

```{r}
# Gemiddelde ongezondheid_score per jaar berekenen
library(dplyr)
library(ggplot2)

# Calculate average unhealthiness score per year and plot
# Make sure the column with city name is correctly named

merged_data %>%
  filter(Regioaanduiding.Gemeentenaam..naam..x %in% c("Rotterdam", "Krimpenerwaard")) %>%
  group_by(Perioden, Regioaanduiding.Gemeentenaam..naam..x) %>%
  summarise(avg_unhealthiness = mean(ongezondheid_score, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = Perioden, y = avg_unhealthiness, color = Regioaanduiding.Gemeentenaam..naam..x)) +
  geom_line() +
  scale_y_continuous(breaks = seq(11,19, by = 0.5), limits =c(11,18.5)) +
  geom_point() +
  labs(
    title = "Average Unhealthiness Score: Rotterdam vs Krimpenerwaard",
    x = "Year",
    y = "Unhealthiness Score",
    color = "Place"
  ) +
  theme_minimal()
```

## 3.4 Visualize spatial variation

```{r visualise_map}

merged_data <- read_csv("data/Data/merged_data.csv")
maps <- cbs_get_maps()
prov_map_yr <- max(maps$year[maps$region == "provincie"])

prov_sf <- cbs_get_sf(region = "provincie", year = prov_map_yr)

zh_sf <- prov_sf %>% filter(statnaam == "Zuid-Holland")

ggplot(zh_sf) +
  geom_sf(fill = "#2b8cbe", colour = "white") +
  theme_void() +
  labs(title = paste0("Provincie Zuid-Holland – CBS kaart ", prov_map_yr))

muni_sf <- cbs_get_sf("provincie", prov_map_yr)

#wijken en buurten er over heen
prov_map_yr <- max(cbs_get_maps()$year[cbs_get_maps()$region == "provincie"])
zh_sf <- cbs_get_sf("provincie", prov_map_yr) %>%
  filter(statnaam == "Zuid-Holland")

wijk_map_yr <- max(cbs_get_maps()$year[cbs_get_maps()$region == "wijk"])
wijken_sf <- cbs_get_sf("wijk", wijk_map_yr)


merged_data <- merged_data %>%
  mutate(Distance_cafes = if_else(
    Horeca.Cafés.en.dergelijke.Afstand.tot.café.e.d...km.> 1,
    "Cafes further than 1 km",
    "Cafes closer than 1 km"
  ))

#write.csv(merged_data, "data/Data/merged_data.csv")

#multipolygon koppelen aan merged_goeie (die wijkcodes)
wijken_sf<-sf::st_as_sf(wijken_sf)
merged_2016 <- merged_data %>%
  filter(Perioden == 2016)

merged_2016<- as.data.frame(merged_2016)

#merged_2016$geometry <- NULL

wijken_sf <- wijken_sf %>%
  rename("Regioaanduiding.Codering..code." = "statcode")

merged_2016 <- merged_2016 %>% merge(wijken_sf, 
                                     by = "Regioaanduiding.Codering..code.")



##### Poging 3 ------goeieee
library(cbsodataR)
library(ggplot2)
library(dplyr)
library(sf)
library(stringr)

# 1. Most-recent vintages
maps      <- cbs_get_maps()
prov_year <- max(maps$year[maps$region == "provincie"])
wijk_year <- max(maps$year[maps$region == "wijk"])

# 2. Read layers (will return data.frames if Tibble Hunter is on)
zh_sf_raw     <- cbs_get_sf("provincie", prov_year) |>
  filter(statnaam == "Zuid-Holland")

wijken_sf_raw <- cbs_get_sf("wijk", wijk_year)

# 3. Keep neighbourhoods in Rotterdam & Krimpenerwaard
gem_codes <- c("0599", "1931")                      # GM-codes → digits
wijken_subset_raw <- wijken_sf_raw |>
  mutate(gem_code = str_extract(statcode, "\\d{4}")) |>
  filter(gem_code %in% gem_codes)

# 4. Convert back to sf **here**
zh_sf        <- st_as_sf(zh_sf_raw)
wijken_subset <- st_as_sf(wijken_subset_raw)

# 5. Plot

merged_2016 <- st_as_sf(merged_2016)

ggplot() +
  geom_sf(data = merged_2016,
          aes(fill = Distance_cafes), colour = "white", linewidth = .15) +
  theme_minimal() +
  labs(title = sprintf("Neighbourhoods in Rotterdam & Krimpenerwaard (%s)", wijk_year),
       fill  = "Neighbourhood") +
  guides(fill = guide_legend(override.aes = list(colour = "black")))


```

Here you provide a description of why the plot above is relevant to your specific social problem.

## 3.5 Visualize sub-population variation

What is the average obesity rate from the different neighbourhoods. This plotted in a box plot against the percentage of excessive alcohol use.

```{r visualise_subpopulations}
library(tidyverse)


#omzetten naar numeric + calculating average obesity rate
mean(as.numeric(merged_2016$Onder..en.overgewicht.Mate.van.overgewicht.Ernstig.overgewicht....), na.rm = TRUE) #15.56333

#subgroup
merged_2016 = mutate(merged_2016, Obesity_rate = ifelse(Onder..en.overgewicht.Mate.van.overgewicht.Ernstig.overgewicht.... >=15.56333,
                                                   "Above_average", "Below_average"))

write.csv(merged_2016, "Data/data/merged_2016.csv")
merged_2016$Alcoholgebruik.Overmatige.drinker.... <- merged_2016$Alcoholgebruik.Overmatige.drinker.... %>% as.numeric()

#plotten
ggplot(merged_2016, aes(x=Obesity_rate, y=Alcoholgebruik.Overmatige.drinker....))+
  geom_boxplot() +
  labs(x="Obesity rate", y="Percentage of excessive alcohol use", title = "Alcohol vs obesity rate 2016")
```

Here you provide a description of why the plot above is relevant to your specific social problem.

## 3.6 Event analysis

Analyze the relationship between two variables.

```{r analysis}
library(dplyr)
library(ggplot2)

wijken_data <- merged_data %>%
  filter(Regioaanduiding.Soort.regio..omschrijving..x == "Wijk")
wijken_data <- wijken_data %>%
  filter(Alcoholgebruik.Overmatige.drinker.... != ".")


wijken_data$Alcoholgebruik.Overmatige.drinker.... <-
  as.numeric(gsub(",", ".", wijken_data$Alcoholgebruik.Overmatige.drinker....))

  
  library(ggplot2)
  
ggplot(wijken_data, aes(
    x = Perioden,
    y = Alcoholgebruik.Overmatige.drinker....,
    group = Wijken.en.buurten.x,
    color = Wijken.en.buurten.x
  )) +
    geom_line() +
  geom_vline(xintercept = 2020) +
  annotate("text", x =2019, y=8.5,size = 5, label="COVID-19\nCrisis") +
    geom_point(size = 1.5) +
    scale_y_continuous(breaks = seq(4, 9, 0.5), limits = c(4, 9)) +
    labs(
      title = "Excessive alcohol consumption per neighborhood over time",
      x = "Year",
      y = "% Excessive drinkers",
      color = "Neighborhood"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      legend.text = element_text(size = 6),
      legend.title = element_text(size = 8),
      legend.key.size = unit(0.4, "cm"),
      plot.title = element_text(size = 16, face = "bold"),
      axis.text = element_text(size = 12)
    )

```

Here you provide a description of why the plot above is relevant to your specific social problem.

# Part 4 - Discussion

## 4.1 Discuss your findings

# Part 5 - Reproducibility

## 5.1 Github repository link

Provide the link to your PUBLIC repository here: ...

## 5.2 Reference list

Use APA referencing throughout your document.
