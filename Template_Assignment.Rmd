---
title: "Template"
author: "Studentnames and studentnumbers here"
date: "`r Sys.Date()`"
output: pdf_document
---

# Set-up your environment

```{r package_install, include=FALSE}
#install.packages("tidyverse")
```

```{r packages}
require(tidyverse)
library(readr)
```

# Title Page

Include your names

Include the tutorial group number

Include your tutorial lecturer's name

# Part 1 - Identify a Social Problem

Use APA referencing throughout your document. [Here's a link to some explanation.](https://www.mendeley.com/guides/apa-citation-guide/)

## 1.1 Describe the Social Problem (Isabel)

Include the following:

-   Why is this relevant?

-   ...

# Part 2 - Data Sourcing

## 2.1 Load in the data

Preferably from a URL, but if not, make sure to download the data and store it in a shared location that you can load the data in from. Do not store the data in a folder you include in the Github repository!

```{r loading_data}
Alcohol_data_2016<- read_csv("data/Data/Gezondheid_per_wijk_en_buurt__2022_18062025_140754.csv")

Alcohol_data_2020<- read_csv("data/Data/Gezondheid_per_wijk_en_buurt__2022_18062025_140356.csv")

Alcohol_data_2022<- read_csv("data/Data/Gezondheid_per_wijk_en_buurt__2022_18062025_140404.csv")

Nabijheid_voorzieningen2016 <- read_csv("nabijheid_voorzieningen2016.csv")

Nabijheid_voorzieningen2020 <- read_csv("nabijheid_voorzieningen2020.csv")

Nabijheid_voorzieningen2022 <- read_csv("nabijheid_voorzieningen2022.csv")


```

midwest is an example dataset included in the tidyverse package

## 2.2 Provide a short summary of the dataset(s) (Levi)

```{r}
#head(dataset)
```

After identifying the social problem and loading the datasets, we will examine these datasets and provide a summary of how they relate to our problem and what information we can actually obtain from them.

We used three different points in time in combination with two variables in the datasets, “alcohol data” and “nabijheid voorzieningen”. Our datasets will provide us with a clear comparison, and by comparing them, we may even be able to identify some relationships between the variables.

Now that the intentions of the use of our datasets are clear, what do our datasets tell us?

The Alcohol_data_2016, Alcohol_data_2020, and Alcohol_data_2022 datasets contain health-related data at a “wijk/ buurt” or neighbourhood/ district level. The datasets contain information about a lot of different data points, such as alcohol use by age groups and health indicators that are possibly linked to alcohol.

The nabijheid_voorzieningen2016, nabijheid_voorzieningen2020, and nabijheid_voorzieningen2022 datasets are used as a second variable, and these datasets contain information about access to local services such as bars, cafés, educational facility proximity, and supermarkets. These datasets are similar to the alcohol datasets, since both of them measure at the neighbourhood or district level.

Both datasets are open data, “alcohol_data” is sourced from the Buurtatlas and the “nabijheid_voorzieningen” is sourced from CBS

``` r
inline_code = TRUE
```

## 2.3 Describe the type of variables included (Levi)

When the datasets are talking about an "overmatige drinker", it's talking about excessive drinkers, so men who drink \>= 21 glasses per week, or women who drink \>= 14 glasses per week.

Both datasets contain the date as the year and have identifier codes that correspond with the neighbourhood or district to which the rest of the data in that row is linked. Both also contain categorical variables like names of the neighbourhood or district, while only alcohol_data also contains data about the age and gender of people used to create the data

percentage_overmatig_drinken is a prominent variable in the alcohol_data dataset, which gives us a percentage of excessive drinkers.

The datasets for “alcohol_data” were created from a health monitor in the Netherlands, utilizing data from multiple data collection sources. Buurtatlas used sample-sized groups to conclude about the data created, having between 350.000 and 550.000 respondents.

# Part 3 - Quantifying

## 3.1 Data cleaning

Say we want to include only larger distances (above 2) in our dataset, we can filter for this.

```{r data_cleaning}
library(dplyr)
library(readr)
nabijheid_voorzieningen2016 <- read_csv("nabijheid_voorzieningen2016.csv")
nabijheid_voorzieningen2020 <- read_csv("nabijheid_voorzieningen2020.csv")
nabijheid_voorzieningen2022 <- read_csv("nabijheid_voorzieningen2022.csv")
merged_data <- nabijheid_voorzieningen2016 %>%
  full_join(nabijheid_voorzieningen2020, by = "Regioaanduiding.Codering..code.", suffix = c("_2016", "_2020")) %>%
  full_join(nabijheid_voorzieningen2022, by = "Regioaanduiding.Codering..code.")
nabijheid_voorzieningen2016$...1 <- NULL
voorzien <- rbind(nabijheid_voorzieningen2016, nabijheid_voorzieningen2020,nabijheid_voorzieningen2022)
write_csv(voorzien,"data/Data/voorzieningen.csv")
merged_data <- voorzien %>%
  merge(AlcoholBuurten, by = "Regioaanduiding.Codering..code.")

setwd("~/Documents/GitHub/School_Opdracht")
AlcoholBuurten <- read_csv("data/AlcoholBuurten.csv")
nabijheid_voorzieningen2016$Perioden <- 2016
nabijheid_voorzieningen2020$Perioden <- 2020
nabijheid_voorzieningen2022$Perioden <- 2022

nabijheid_voorzieningen2016$...1 <- NULL

voorzien <- rbind(nabijheid_voorzieningen2016, nabijheid_voorzieningen2020,nabijheid_voorzieningen2022)
write_csv(voorzien,"data/Data/voorzieningen.csv")
merged_data <- voorzien %>%
  merge(AlcoholBuurten, by = c("Regioaanduiding.Codering..code.", "Perioden"))
write_csv(merged_data,"data/Data/merged_data.csv")

```

Please use a separate 'R block' of code for each type of cleaning. So, e.g. one for missing values, a new one for removing unnecessary variables etc.

## 3.2 Generate necessary variables (Isabel)

Variable 1: Add a column, whether or not the distance to cafes is \>1

```{merged_data <- merged_data %>%}
  mutate(Distance_cafes = if_else(
    Horeca.Cafés.en.dergelijke.Afstand.tot.café.e.d...km.> 1,
    "Cafes further than 1 km",
    "Cafes closer than 1 km"
  ))

```

Variable 2 Kort beschrijven wat ongezondheidsscore inhoudt, gemiddelde van de onderstaande ongezondheidsfactoren.in het engels natuurlijk

```{r gen_var2}
library(dplyr)

# Kolommen selecteren voor de score
cols_to_convert <- c(
  "Roker....",
  "Alcoholgebruik.Zware.drinker....",
  "Alcoholgebruik.Overmatige.drinker....",
  "Lichamelijke.gezondheid.Eén.of.meer.langdurige.aandoeningen....",
  "Hoog.risico.op.angst.of.depressie....",
  "Eenzaamheid.Ernstig.zeer.ernstig.eenzaam...."
)

# Zet komma's naar punten en maak getallen van tekens
merged_data[cols_to_convert] <- lapply(merged_data[cols_to_convert], function(x) {
  x <- gsub(",", ".", x)
  as.numeric(x)
})

# Bereken de ongezondheid_score als gemiddelde van de gekozen kolommen
merged_data <- merged_data %>%
  mutate(
    ongezondheid_score = rowMeans(select(., all_of(cols_to_convert)), na.rm = TRUE)
  )


```

## 3.3 Visualize temporal variation (Isabel)

```{r}
# Gemiddelde ongezondheid_score per jaar berekenen
library(dplyr)
library(ggplot2)

# Calculate average unhealthiness score per year and plot
# Make sure the column with city name is correctly named

merged_data %>%
  filter(Regioaanduiding.Gemeentenaam..naam..x %in% c("Rotterdam", "Krimpenerwaard")) %>%
  group_by(Perioden, Regioaanduiding.Gemeentenaam..naam..x) %>%
  summarise(avg_unhealthiness = mean(ongezondheid_score, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = Perioden, y = avg_unhealthiness, color = Regioaanduiding.Gemeentenaam..naam..x)) +
  geom_line() +
  scale_y_continuous(breaks = seq(11,19, by = 0.5), limits =c(11,18.5)) +
  geom_point() +
  labs(
    title = "Average Unhealthiness Score: Rotterdam vs Krimpenerwaard",
    x = "Year",
    y = "Unhealthiness Score",
    color = "Place"
  ) +
  theme_minimal()
```

## 3.4 Visualize spatial variation (Isabel)

```{r visualise_map}

merged_data <- read_csv("data/Data/merged_data.csv")
maps <- cbs_get_maps()
prov_map_yr <- max(maps$year[maps$region == "provincie"])

prov_sf <- cbs_get_sf(region = "provincie", year = prov_map_yr)

zh_sf <- prov_sf %>% filter(statnaam == "Zuid-Holland")

ggplot(zh_sf) +
  geom_sf(fill = "#2b8cbe", colour = "white") +
  theme_void() +
  labs(title = paste0("Provincie Zuid-Holland – CBS kaart ", prov_map_yr))

muni_sf <- cbs_get_sf("provincie", prov_map_yr)

#wijken en buurten er over heen
prov_map_yr <- max(cbs_get_maps()$year[cbs_get_maps()$region == "provincie"])
zh_sf <- cbs_get_sf("provincie", prov_map_yr) %>%
  filter(statnaam == "Zuid-Holland")

wijk_map_yr <- max(cbs_get_maps()$year[cbs_get_maps()$region == "wijk"])
wijken_sf <- cbs_get_sf("wijk", wijk_map_yr)


merged_data <- merged_data %>%
  mutate(Distance_cafes = if_else(
    Horeca.Cafés.en.dergelijke.Afstand.tot.café.e.d...km.> 1,
    "Cafes further than 1 km",
    "Cafes closer than 1 km"
  ))

#write.csv(merged_data, "data/Data/merged_data.csv")

#multipolygon koppelen aan merged_goeie (die wijkcodes)
wijken_sf<-sf::st_as_sf(wijken_sf)
merged_2016 <- merged_data %>%
  filter(Perioden == 2016)

merged_2016<- as.data.frame(merged_2016)

#merged_2016$geometry <- NULL

wijken_sf <- wijken_sf %>%
  rename("Regioaanduiding.Codering..code." = "statcode")

merged_2016 <- merged_2016 %>% merge(wijken_sf, 
                                     by = "Regioaanduiding.Codering..code.")



##### Poging 3 ------
library(cbsodataR)
library(ggplot2)
library(dplyr)
library(sf)
library(stringr)

# 1. Most-recent vintages
maps      <- cbs_get_maps()
prov_year <- max(maps$year[maps$region == "provincie"])
wijk_year <- max(maps$year[maps$region == "wijk"])

# 2. Read layers (will return data.frames if Tibble Hunter is on)
zh_sf_raw     <- cbs_get_sf("provincie", prov_year) |>
  filter(statnaam == "Zuid-Holland")

wijken_sf_raw <- cbs_get_sf("wijk", wijk_year)

# 3. Keep neighbourhoods in Rotterdam & Krimpenerwaard
gem_codes <- c("0599", "1931")                      # GM-codes → digits
wijken_subset_raw <- wijken_sf_raw |>
  mutate(gem_code = str_extract(statcode, "\\d{4}")) |>
  filter(gem_code %in% gem_codes)

# 4. Convert back to sf **here**
zh_sf        <- st_as_sf(zh_sf_raw)
wijken_subset <- st_as_sf(wijken_subset_raw)

# 5. Plot

merged_2016 <- st_as_sf(merged_2016)

ggplot() +
  geom_sf(data = merged_2016,
          aes(fill = Distance_cafes), colour = "white", linewidth = .15) +
  theme_minimal() +
  labs(title = sprintf("Neighbourhoods in Rotterdam & Krimpenerwaard (%s)", wijk_year),
       fill  = "Neighbourhood") +
  guides(fill = guide_legend(override.aes = list(colour = "black")))


```

Here you provide a description of why the plot above is relevant to your specific social problem.

## 3.5 Visualize sub-population variation (Levi)

What is the average obesity rate in the different neighbourhoods? This is plotted in a box plot against the percentage of excessive alcohol use.

```{r visualise_subpopulations}
library(tidyverse)


#convert to numeric + calculating average obesity rate
mean(as.numeric(merged_2016$Onder..en.overgewicht.Mate.van.overgewicht.Ernstig.overgewicht....), na.rm = TRUE) #15.56333

#subgroup
merged_2016 = mutate(merged_2016, Obesity_rate = ifelse(Onder..en.overgewicht.Mate.van.overgewicht.Ernstig.overgewicht.... >=15.56333,
                                                   "Above_average", "Below_average"))

write.csv(merged_2016, "Data/data/merged_2016.csv")
merged_2016$Alcoholgebruik.Overmatige.drinker.... <- merged_2016$Alcoholgebruik.Overmatige.drinker.... %>% as.numeric()

#plotting
ggplot(merged_2016, aes(x=Obesity_rate, y=Alcoholgebruik.Overmatige.drinker....))+
  geom_boxplot() +
  labs(x="Obesity rate", y="Percentage of excessive alcohol use", title = "Alcohol vs obesity rate 2016")
```

The boxplot is relevant to our specific social problem since it gives an easy and clear overview of the percentage of excessive alcohol use in combination with above or below average obesity rates in Krimpenerwaard and Rotterdam. Our plot is mainly important for clearly stating whether there is a strong correlation between heavy drinkers and obesity rates within an average neighborhood in 2016.  

## 3.6 Event analysis (Levi)

```{r analysis}
library(dplyr)
library(ggplot2)

wijken_data <- merged_data %>%
  filter(Regioaanduiding.Soort.regio..omschrijving..x == "Wijk")
wijken_data <- wijken_data %>%
  filter(Alcoholgebruik.Overmatige.drinker.... != ".")


wijken_data$Alcoholgebruik.Overmatige.drinker.... <-
  as.numeric(gsub(",", ".", wijken_data$Alcoholgebruik.Overmatige.drinker....))

  
  library(ggplot2)
  
ggplot(wijken_data, aes(
    x = Perioden,
    y = Alcoholgebruik.Overmatige.drinker....,
    group = Wijken.en.buurten.x,
    color = Wijken.en.buurten.x
  )) +
    geom_line() +
  geom_vline(xintercept = 2020) +
  annotate("text", x =2019, y=8.5,size = 5, label="COVID-19\nCrisis") +
    geom_point(size = 1.5) +
    scale_y_continuous(breaks = seq(4, 9, 0.5), limits = c(4, 9)) +
    labs(
      title = "Excessive alcohol consumption per neighborhood over time",
      x = "Year",
      y = "% Excessive drinkers",
      color = "Neighborhood"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      legend.text = element_text(size = 6),
      legend.title = element_text(size = 8),
      legend.key.size = unit(0.4, "cm"),
      plot.title = element_text(size = 16, face = "bold"),
      axis.text = element_text(size = 12)
    )

```

The graph gives us the relationship between the years 2016, 2018, 2020, 2022, and the percentage of excessive alcohol consumption per neighbourhood over this period of time. Each colored line represents a different neighbourhood, and the combination of all these variables gives a somewhat consistent outcome for each neighbourhood. The vertical line is representative of the “COVID-19 Crisis”, since this crisis would be the cause of a noticeable decline in excessive drinking from 2016 to 2020. The graph also shows that after COVID-19, the amount of excessive drinkers returned to their original state, and for some neighbourhoods, even ended up higher than before COVID-19.

This graph would be relevant to our research on alcohol abuse and access to local services, since most of these local services where you would be able to drink alcohol were closed during COVID-19, so this shows the strong correlation that these variables ultimately have, regardless of the distance between residents and their local services such as bars and café’s.

# Part 4 - Discussion

## 4.1 Discuss your findings

Since each box in the boxplot of part 3.5 represents the distribution of excessive alcohol usage within the above-average and below-average obesity rates, we can conclude from this graph that the above-average group shows higher variation in excessive alcohol usage. The group with below-average obesity rates has a tighter distribution of excessive alcohol usage, but has more outliers in both directions of the boxplot. This tells us that areas with higher obesity rates may also tend to have more variation in alcohol behaviour, and since both alcohol usage and obesity rates are major public health concerns, this graph would be especially useful for our problem.

The graph of 3.6 shows heavy drinking dropped during the 2020 COVID-19 pandemic in every neighborhood, perhaps due to lockdowns and limited nightlife availability, such as access to local services such as bars and café’e. However, by 2022, consumption levels had returned in most neighborhoods, especially cities. This reflects a return to pre-pandemic behaviors and the continuation of regional differences in alcohol consumption.

# Part 5 - Reproducibility

## 5.1 Github repository link

Provide the link to your PUBLIC repository here: ...

## 5.2 Reference list

Use APA referencing throughout your document.
